# Сервис сбора метрик и алертинга

Разработан сервер + агент (клиент). Ближайший аналог - node exporter. Это пример учебного большого проекта, который был выполнен в рамках прохождения курса "Продвинутый Go-разработчик" на Яндекс.Пактикуме. Все работы по проекту были завершены в срок (двухнедельные спринты) на протяжении всего курса с 29.11.2023 по 19.06.2024.

Особенности:
- Каждый инкремент проверка на предоставленных автотестах ([README автотестов](https://github.com/Yandex-Practicum/go-autotests)) и только тогда ревью у ментора
- Первые спринты без внешних пакетов
- Строгие дедлайны, иначе переход на график в своем темпе или перевод в группы, идущие следом
- Обратная совместимость на дистанции 25 инкрементов (несколько инкрементов в 1 двухнедельный спринт)
- Самостоятельный разбор логов автотестов и фиксы, иначе инкременты не пройти
- Pull Request на мерж в main и отправка на ревью. В случае апрува мерж в main
- Стараться выполнить задачу самостоятельно, в крайнем случае не более 2-х 1:1 в спринт или общение в комьюнити каналах 

## Фичи сервера

- [x] Запись в память или в PostgreSQL с использованием слоя `storage`
- [x] Синхронная и асинхронная запись в файл с восстановлением из файла
- [x] Работа с дефолтным веб-сервером, включая routes и `middleware` или внешним
- [x] Прием метрик в текстовом и JSON форматах
- [x] Прием метрик батчами
- [x] Ответы сервера регламентированным кодом и статусом
- [x] Логирование входящих запросов и ответов через `middleware` - uri, method, status, duration, size
- [x] Retriable-подключение к PostreSQL
- [x] Оптимизация с использованием профилировщика pprof
- [x] Проверка доверенной подсети для приема метрик

## Фичи агента

- [x] Источник метрик из пакета `runtime`, `gopsutil` и кастомные метрики
- [x] Источник типа `gauge`, `float64` — новое значение должно замещать предыдущее
- [x] Источник типа `counter`, `int64` — новое значение должно добавляться к предыдущему 
- [x] Полинг и отправка метрик с заданным интервалом времени 
- [x] Отправка данных в текстовом и JSON форматах
- [x] Отправка данных батчами

## Общие фичи для сервера и агента

- [x] Для конфигурирования используются env, флаги и JSON-файл
- [x] Возможность замены zap-логера на иной
- [x] Поддержка gzip для передачи и приема текстовых и json форматов данных
- [x] Поддержка подписи данных по алгоритму SHA256
- [x] Поддержка ассиметричного шифрования
- [x] Сформирован свой статический анализатор кода, весь код ему соответствует, добавлена документация к нему в формате godoc. Состоит из всех анализаторов пакета `golang.org/x/tools/go/analysis/passes`, всех анализаторов класса `SA` пакета `staticcheck.io`, 2-х публичных анализаторов `errwrap`, `noctx` и одного собственного анализатора, запрещающего использовать прямой вызов `os.Exit` в функции `main` пакета `main`.
- [x] Реализован gracefull shutdown - данные, которые находятся в процессе обработки на момент получения сигнала, успешно передаются агентом на сервер, а сервер успешно сохраняет все несохранённые данные
- [x] Поддержка обмена данными по gRPC - всех возможностей конфигурации gRPC-сервера и агента аналогично конфигурациям HTTP-сервера

## Начало работы

1. Склонируйте репозиторий в любую подходящую директорию на вашем компьютере.

Далее в зависимости от среды запуска:

## В любой IDE, где уже может исполняться код на Go.

1. Выполните команду `go run ./cmd/server/` для запуска сервера
2. Выполните команду `go run ./cmd/agent/` для запуска агента

## MacOS, создание исполняемых файлов

1. Для создания исполняемого файла сервера `go build -o ./cmd/server/server ./cmd/server/*.go`
2. Для файла агента `go build -o ./cmd/server/agent ./cmd/agent/*.go`

## Запуск сервера

Сервис стартует со значениями по умолчанию. Опционально можно работать с флагами, переменными окружения или загружать конфиг из JSON-файла:

### Flags

```
./server --help 
```

- a - string, server address
- c - string, path to json configuration file
- crypto-key - string, path to pem private key file
- d - string, database dsn
- f - string, file storage path
- i - int,  store interval
- k - string, secret key
- r - bool, restore saved data
- t - string, trusted subnet

### ENV

- ADDRESS - адрес веб-сервера (по умолчанию `localhost:8080`)
- STORE_INTERVAL - 0 для синхронного хранения, иначе асинхронное (по умолчанию `0`)
- FILE_STORAGE_PATH - полное имя файла (по умолчанию `/tmp/metrics-db.json`)
- RESTORE - восстанавливать значения метрик из файла (по умолчанию `true`)
- DATABASE_DSN - адрес подключения к БД (по умолчанию пустое значение)
- KEY - ключ для проверки подписи: полученного и вычисленного хеша по алгоритму SHA256 (по умолчанию пустое значение)
- CRYPTO_KEY - путь до приватного ключа /path/to/key.pem (по умолчанию пустое значение)
- TRUSTED_SUBNET - строковое представление бесклассовой адресации (CIDR) - доверенная подсеть (по умолчанию пустое значение)
- CONFIG - имя файла конфигурации /tmp/config.json (по умолчанию пустое значение)

### JSON-файл

```
{
    "address": "localhost:8080", // аналог переменной окружения ADDRESS или флага -a
    "restore": true, // аналог переменной окружения RESTORE или флага -r
    "store_interval": "1", // аналог переменной окружения STORE_INTERVAL или флага -i
    "store_file": "/path/to/file.db", // аналог переменной окружения STORE_FILE или -f
    "database_dsn": "", // аналог переменной окружения DATABASE_DSN или флага -d
    "crypto_key": "/path/to/key.pem" // аналог переменной окружения CRYPTO_KEY или флага -crypto-key
} 
```

## Запуск агента

Сервис стартует со значениями по умолчанию. Опционально можно работать с флагами, переменными окружения или загружать конфиг из JSON-файла:

### Flags

```
./agent --help
```

- a - string, server address
- c - string, path to json configuration file
- crypto-key - string, path to pem public key file
- i - string, real ip
- k - string, secret key
- l - int, rate limit (a number of workers)
- p - int, poll interval (in seconds)
- r - int, report interval (in seconds)

### ENV

- ADDRESS - адрес сервера метрик (по умолчанию `localhost:8080`)
- REPORT_INTERVAL - отправлять метрики на сервер в секундах (по умолчанию `10`)
- POLL_INTERVAL - обновлять метрики из пакетов `runtime`, `gopsutil` в секундах (по умолчанию `2`)
- KEY - ключ для вычисления хеша по алгоритму SHA256 (подписи отправляемых метрик) (по умолчанию пустое значение) 
- RATE_LIMIT - ограничение количества одновременно исходящих метрик на сервер (по умолчанию `1`)
- CRYPTO_KEY - путь до публичного ключа /path/to/key.pem (по умолчанию пустое значение)
- REAL_IP - IP адрес клиента (по умолчанию `127.0.0.1`)
- CONFIG - имя файла конфигурации /tmp/config.json (по умолчанию пустое значение)

### JSON-файл

```
{
    "address": "localhost:8080", // аналог переменной окружения ADDRESS или флага -a
    "report_interval": "1", // аналог переменной окружения REPORT_INTERVAL или флага -r
    "poll_interval": "1", // аналог переменной окружения POLL_INTERVAL или флага -p
    "crypto_key": "/path/to/key.pem" // аналог переменной окружения CRYPTO_KEY или флага -crypto-key
} 
```

## Тестирование

1. В корне репозитория выполните команду `go test -v -race ./...` для запуска локальных тестов сервера, агента и определения Race Condition.
